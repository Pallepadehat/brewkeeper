name: Update Homebrew Formula

on:
  workflow_run:
    workflows: ["Release Binaries"]
    types: [completed]

jobs:
  update-tap:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Get release info
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RELEASE=$(gh api repos/Pallepadehat/brewkeeper/releases/latest --jq '.tag_name')
          VERSION="${RELEASE#v}"
          echo "tag=${RELEASE}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Download release assets and compute SHA256
        id: sha
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          BASE="https://github.com/Pallepadehat/brewkeeper/releases/download/${TAG}"

          curl -sL -o darwin.tar.gz "${BASE}/brewkeeper-darwin-arm64.tar.gz"
          curl -sL -o linux.tar.gz "${BASE}/brewkeeper-linux-x64.tar.gz"

          DARWIN_SHA=$(shasum -a 256 darwin.tar.gz | awk '{print $1}')
          LINUX_SHA=$(shasum -a 256 linux.tar.gz | awk '{print $1}')

          echo "darwin_sha256=${DARWIN_SHA}" >> "$GITHUB_OUTPUT"
          echo "linux_sha256=${LINUX_SHA}" >> "$GITHUB_OUTPUT"
          echo "darwin_url=${BASE}/brewkeeper-darwin-arm64.tar.gz" >> "$GITHUB_OUTPUT"
          echo "linux_url=${BASE}/brewkeeper-linux-x64.tar.gz" >> "$GITHUB_OUTPUT"

      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: Pallepadehat/homebrew-brewkeeper
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: tap
          persist-credentials: false

      - name: Update formula
        run: |
          mkdir -p tap/Formula
          cat > tap/Formula/brewkeeper.rb << EOF
          class Brewkeeper < Formula
            desc "Clean terminal UI for safer Homebrew upgrades"
            homepage "https://github.com/Pallepadehat/brewkeeper"
            version "${{ steps.release.outputs.version }}"
            license "MIT"

            on_macos do
              url "${{ steps.sha.outputs.darwin_url }}"
              sha256 "${{ steps.sha.outputs.darwin_sha256 }}"
            end

            on_linux do
              url "${{ steps.sha.outputs.linux_url }}"
              sha256 "${{ steps.sha.outputs.linux_sha256 }}"
            end

            def install
              bin.install "brewkeeper"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/brewkeeper --version")
            end
          end
          EOF
          sed -i 's/^          //' tap/Formula/brewkeeper.rb

      - name: Commit and push
        working-directory: tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${{ secrets.TAP_GITHUB_TOKEN }}@github.com/Pallepadehat/homebrew-brewkeeper.git"
          git add Formula/brewkeeper.rb
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "brewkeeper ${{ steps.release.outputs.tag }}"
          git push
