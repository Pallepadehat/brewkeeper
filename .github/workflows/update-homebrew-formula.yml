name: Update Homebrew Formula

on:
  release:
    types: [published]

jobs:
  update-tap:
    runs-on: ubuntu-latest
    steps:
      - name: Get release info
        id: release
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Download source tarball and compute SHA256
        id: sha
        run: |
          TAG="${{ steps.release.outputs.tag }}"
          URL="https://github.com/Pallepadehat/brewkeeper/archive/refs/tags/${TAG}.tar.gz"
          curl -sL -o source.tar.gz "${URL}"
          SHA=$(shasum -a 256 source.tar.gz | awk '{print $1}')
          echo "sha256=${SHA}" >> "$GITHUB_OUTPUT"
          echo "url=${URL}" >> "$GITHUB_OUTPUT"

      - name: Checkout tap repository
        uses: actions/checkout@v4
        with:
          repository: Pallepadehat/homebrew-brewkeeper
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: tap
          persist-credentials: false

      - name: Update formula
        run: |
          mkdir -p tap/Formula
          cat > tap/Formula/brewkeeper.rb << 'FORMULA'
          class Brewkeeper < Formula
            desc "Clean terminal UI for safer Homebrew upgrades"
            homepage "https://github.com/Pallepadehat/brewkeeper"
            url "${{ steps.sha.outputs.url }}"
            sha256 "${{ steps.sha.outputs.sha256 }}"
            license "MIT"

            depends_on "bun" => :build

            def install
              system "bun", "install", "--frozen-lockfile"
              system "bun", "build", "--compile", "--outfile", "brewkeeper", "src/index.tsx"
              bin.install "brewkeeper"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/brewkeeper --version")
            end
          end
          FORMULA
          # Remove leading whitespace from heredoc
          sed -i 's/^          //' tap/Formula/brewkeeper.rb

      - name: Commit and push
        working-directory: tap
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${{ secrets.TAP_GITHUB_TOKEN }}@github.com/Pallepadehat/homebrew-brewkeeper.git"
          git add Formula/brewkeeper.rb
          git commit -m "brewkeeper ${{ steps.release.outputs.tag }}"
          git push
